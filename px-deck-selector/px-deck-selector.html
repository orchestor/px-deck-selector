<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../px-polymer-font-awesome/polymer-font-awesome.html" />

<!--
Element which displays a dropdown of decks and returns the url for the selected deck.

Use the px-deck-selector element to enable your users to choose a deck from a drop-down list. Set the decks using an array of objects with `name` and `url` properties. When a user selects a new deck, the `selected-deck-url` will be updated.

##### Usage

    <px-deck-selector decks="{{...}}" selected-deck="{{...}}"></px-deck-selector>

@demo demo.html
-->

<link rel="import" href="css/px-deck-selector-styles.html">

<dom-module id="px-deck-selector">
  <template>
    <style include="px-deck-selector-styles"></style>
    <style include="px-theme-styles"></style>
    <div class="dropdown-text" on-click="_toggleDropdown" hidden$="{{!isDecks}}">
      <span class="epsilon">{{selectedDeck.name}}</span>
      <iron-icon icon="fa:fa-caret-down"></iron-icon>
    </div>
    <ul id="dropdown" class="dropdown-menu list-bare" hidden>
      <template is="dom-repeat" items="{{decks}}" as="deck">
        <li on-click="_selectDeck">
          <div class="u-p--">{{deck.name}}</div>
        </li>
      </template>
      <template is="dom-if" if="{{configOptions.edit}}">
        <li on-click="_triggerDeckEvent" class="deck-editor">
          <div class="u-p--">{{configOptions.actionType}}</div>
        </li>
      </template>
    </ul>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-deck-selector',

    properties: {

      /**
       * List of decks to display.
       *
       *      [
       *          {id: 1, name: 'First Deck', url: '/deck1'},
       *          {id: 2, name: 'Second Deck', url: '/deck2'},
       *          {id: 3, name: 'Third Deck', url: '/deck3'}
       *      ]
       *
       * The first deck will always be selected initially.
       * Each object needs a `name` and `url` property.
       */
      decks: {
        type: Array,
        value: function() {
          return [];
        },
        observer: '_setDecks'
      },

      /**
       *
       * Only used for communicating out the selected deck.  The first deck
       * in the list of decks will always be selected initially.
       */
      selectedDeck: {
        type: Object,
        value: function() {
          return {};
        },
        notify: true
      },

      /**
       * @private
       */
      isDecks: {
        type: Boolean,
        value: false
      },

      /**
       * @private
       * needed for IE...
       */
      isDropdownOpen: {
        type: Boolean,
        value: false
      },

      /*
       * Config option
       * */
      configOptions: {
        value: null,
        notify: true
      }
    },

    _setDecks: function() {
      this.set('isDecks', this.decks && this.decks.length > 0);

      var selectedDeck = null;

      if (this.isDecks) {
        selectedDeck = this.decks[0];
      }

      this.set('selectedDeck', selectedDeck);
    },

    _toggleDropdown: function(e) {

      this.isDropdownOpen = !this.isDropdownOpen;
      this.toggleAttribute('hidden', !this.isDropdownOpen, this.$.dropdown);
      /*
       * adding event listener to the document when menu is opened
       * */
      if (e) {
        this._handleDocumentClick();
      }
    },

    _selectDeck: function(e) {
      this.set('selectedDeck', e.model.deck);
      this._toggleDropdown(false);
    },

    /*
     *  this will allow to take care of adding or removing deck
     *  which needs to be handled from the host component
     *
     * @event _triggerDeckEvent
     * */
    _triggerDeckEvent: function(e) {
      this.fire('deckEvent', e.model.configOptions.eventType);
      this._toggleDropdown(false);
    },

    /*
     * only called when the user clicked outside of menu
     * */
    _closeMenu: function(e, el) {
      if (!el.contains(e.target)) {
        this.isDropdownOpen = false;
        el.setAttribute('hidden', true);
        document.removeEventListener('mouseup', this.evtHandler, false);
      }
    },

    /*
     * Adding and removing event listener on the document
     * */
    _handleDocumentClick: function() {

      var el = this.$.dropdown;
      var self = this;

      if (!el.hasAttribute('hidden')) {
        document.addEventListener('mouseup', self.evtHandler = function(e) {
          self._closeMenu(e, el)
        }, false);
        //document.ddMenu = this;
      } else {
        document.removeEventListener('mouseup', self.evtHandler, false);
        //document.ddMenu = null;
      }
    }
  });
</script>
